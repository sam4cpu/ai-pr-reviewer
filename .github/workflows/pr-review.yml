name: AI PR Reviewer â€” Networked, Predictive & Self-Evolving

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * 1"

env:
  NETWORK_HUB_REPO: ${{ secrets.NETWORK_HUB_REPO }}
  NETWORK_HUB_TOKEN: ${{ secrets.NETWORK_HUB_TOKEN }}

jobs:
  ai_reviewer_full_pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # --- Base setup ---
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        uses: ./.github/actions/install_deps

      # --- Reviewer & AI Pipeline ---
      - name: Fetch PR diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -sSL -H "Accept: application/vnd.github.v3.diff" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            ${{ github.event.pull_request.url }} > pr_diff.patch || true

      - name: Run Predictive/Adaptive Reviewer
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python .github/actions/ai_pr_reviewer/reviewer_predictive.py \
          || python .github/actions/ai_pr_reviewer/reviewer.py

      # --- Global Hub Sync ---
      - name: Pull Global Hub State
        run: |
          python .github/actions/ai_pr_reviewer/global_sync.py pull

      - name: Fuse Local + Global Adaptive State
        run: |
          python .github/actions/ai_pr_reviewer/network_fusion.py

      - name: Calibrate Reviewer Confidence
        run: |
          python .github/actions/ai_pr_reviewer/reviewer_confidence.py

      # --- Dashboard & Reports ---
      - name: Generate Global Dashboard
        run: |
          python .github/actions/ai_pr_reviewer/generate_dashboard_v19.py

      - name: Generate Recruiter Summary Report
        run: |
          python .github/actions/ai_pr_reviewer/recruiter_report.py

      - name: Run Self-Evolution
        run: |
          python .github/actions/ai_pr_reviewer/self_evolve.py

      # --- Upload Artifacts ---
      - uses: actions/upload-artifact@v4
        with:
          name: ai-reviewer-full-artifacts
          path: |
            ai_review.md
            ai_self_eval.json
            review_history.json
            adaptive_weights.json
            adaptive_network_weights.json
            reviewer_confidence.json
            dashboard_v19.html
            recruiter_report.md
            evolution_badge.svg
            evolution_state.json
            project_evolution_report.md
          if-no-files-found: ignore

      - name: Cleanup hub temp directory
        run: rm -rf /tmp/ai_hub || true

      # --- CI-Safe Push to Hub ---
      - name: Push merged state & badge back to hub
        env:
          NETWORK_HUB_REPO: ${{ secrets.NETWORK_HUB_REPO }}
          NETWORK_HUB_TOKEN: ${{ secrets.NETWORK_HUB_TOKEN }}
        run: |
          python .github/actions/ai_pr_reviewer/global_sync.py push

      # --- PR Comment Summary ---
      - name: Post Summary Comment to PR
        if: github.event.pull_request.number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SUMMARY="Network sync, dashboard, recruiter report, and evolution badge generated successfully."
          curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"body\": \"### Full Pipeline Summary\\n\\n$SUMMARY\\n\\n![Evolution Badge](https://github.com/${GITHUB_REPOSITORY}/blob/main/assets/evolution_badge.svg)\"}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments"

      











