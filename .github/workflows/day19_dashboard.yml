name: Dashboard & Final Report

on:
  workflow_dispatch:
  pull_request:
    types: [synchronize, opened, reopened]

jobs:
  day19_dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install pandas matplotlib numpy jinja2

      - name: Ensure artifacts present
        run: |
          echo "Print working directory and files"
          pwd && ls -la

      - name: Generate Unified Dashboard (v19)
        run: |
          python .github/actions/ai_pr_reviewer/generate_dashboard_v19.py

      - name: Produce Final Report
        run: |
          python .github/actions/ai_pr_reviewer/final_report.py

      - name: Run smoke tests
        run: |
          pip install pytest
          pytest -q

      - name: Upload Dashboard & Report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: final-dashboard-and-report
          path: |
            dashboard_v19.html
            dashboard_summary.json
            final_report.md
            chart_*.png
            ai_review.md
            review_history.json
            ai_adaptive_log.json
